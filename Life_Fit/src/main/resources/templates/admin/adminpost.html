<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:inline="javascript">
<head>
    <meta charset="UTF-8">
    <title>ê²Œì‹œê¸€ ë° ëŒ“ê¸€ ê´€ë¦¬</title>
    <style>
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        button { cursor: pointer; }

        #editModal, #postEditModal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background: #fff;
            padding: 20px;
            border: 2px solid #ccc;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            width: 400px;
        }

        textarea {
            width: 100%;
            height: 100px;
            white-space: pre-line;
        }
    </style>
</head>
<body>
<h2>ğŸ“‹ ê²Œì‹œê¸€ ë° ëŒ“ê¸€ ê´€ë¦¬</h2>

<!-- ğŸ” ê²€ìƒ‰ -->
<form method="get" th:action="@{/api/admin/posts/html}">
    <input type="text" name="userId" placeholder="íšŒì› ì•„ì´ë””ë¡œ ê²€ìƒ‰" th:value="${userId}">
    <button type="submit">ê²€ìƒ‰</button>
</form>

<!-- ğŸ“„ ê²Œì‹œê¸€ ëª©ë¡ -->
<table>
    <thead>
    <tr>
        <th>ë²ˆí˜¸</th>
        <th>ì œëª©</th>
        <th>ë‚´ìš©</th>
        <th>ë‹‰ë„¤ì„</th>
        <th>íšŒì›ID</th>
        <th>ì‘ì„±ì¼</th>
        <th>ìˆ˜ì •</th>
        <th>ì‚­ì œ</th>
        <th>ëŒ“ê¸€</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="post : ${postPage.content}">
        <td th:text="${post.bno}">1</td>
        <td th:text="${post.title}">ì œëª©</td>
        <td th:text="${post.content}">ë‚´ìš©</td>
        <td th:text="${post.nickname}">ë‹‰ë„¤ì„</td>
        <td th:text="${post.userId}">íšŒì›ID</td>
        <td th:text="${#temporals.format(post.regdate, 'yyyy-MM-dd HH:mm')}">ì‘ì„±ì¼</td>
        <td>
            <button type="button"
                    class="edit-post-btn"
                    th:attr="data-bno=${post.bno}, data-title=${post.title}, data-content=${post.content}">
                ìˆ˜ì •
            </button>
        </td>
        <td>
            <form th:action="@{/api/admin/posts/delete/{bno}(bno=${post.bno})}" method="post">
                <button type="submit" onclick="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">ì‚­ì œ</button>
            </form>
        </td>
        <td>
            <button type="button" th:attr="onclick='loadComments(' + ${post.bno} + ')'">ğŸ’¬ ëŒ“ê¸€ ë³´ê¸°</button>
        </td>
    </tr>
    </tbody>
</table>

<!-- ëŒ“ê¸€ í‘œì‹œ ì˜ì—­ -->
<div id="comments-section"></div>

<!-- ëŒ“ê¸€ ìˆ˜ì • ëª¨ë‹¬ -->
<div id="editModal">
    <h3>ëŒ“ê¸€ ìˆ˜ì •</h3>
    <form onsubmit="submitEditComment(event)">
        <textarea id="editCommentContent"></textarea>
        <input type="hidden" id="editCno">
        <input type="hidden" id="editBno">
        <button type="submit">ì €ì¥</button>
        <button type="button" onclick="closeEditModal()">ì·¨ì†Œ</button>
    </form>
</div>

<!-- ê²Œì‹œê¸€ ìˆ˜ì • ëª¨ë‹¬ -->
<div id="postEditModal">
    <h3>ê²Œì‹œê¸€ ìˆ˜ì •</h3>
    <form onsubmit="submitPostEdit(event)">
        <label>ì œëª©:</label><br>
        <input type="text" id="editPostTitle" required><br><br>
        <label>ë‚´ìš©:</label><br>
        <textarea id="editPostContent" required></textarea>
        <input type="hidden" id="editPostBno">
        <br>
        <button type="submit">ì €ì¥</button>
        <button type="button" onclick="closePostEditModal()">ì·¨ì†Œ</button>
    </form>
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        document.querySelectorAll(".edit-post-btn").forEach(btn => {
            btn.addEventListener("click", function () {
                const bno = this.dataset.bno;
                const title = this.dataset.title;
                const content = this.dataset.content;
                openPostEditModal(bno, title, content);
            });
        });
    });

    function loadComments(bno) {
        fetch(`/api/admin/posts/${bno}/comments`)
            .then(res => res.json())
            .then(data => {
                const section = document.getElementById("comments-section");
                section.innerHTML = "";
                if (!data || data.length === 0) {
                    section.innerHTML = "<p>ğŸ“¬ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
                    return;
                }

                const table = document.createElement("table");
                table.innerHTML = `
                    <thead>
                        <tr><th>ì‘ì„±ì</th><th>ë‚´ìš©</th><th>ì‘ì„±ì¼</th><th>ì‚­ì œ</th><th>ìˆ˜ì •</th></tr>
                    </thead>
                    <tbody>
                        ${data.map(comment => `
                        <tr>
                            <td>${comment.writer}</td>
                            <td style="white-space:pre-line;">${comment.comment}</td>
                            <td>${new Date(comment.regdate).toLocaleString()}</td>
                            <td><button onclick="deleteComment(${comment.cno}, ${bno})">ì‚­ì œ</button></td>
                            <td><button onclick="openEditModal(${comment.cno}, \`${comment.comment}\`, ${bno})">ìˆ˜ì •</button></td>
                        </tr>`).join('')}
                    </tbody>`;
                section.appendChild(table);
            });
    }

    function deleteComment(cno, bno) {
        if (!confirm("ì •ë§ ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        fetch(`/api/admin/posts/comments/${cno}`, { method: "DELETE" })
            .then(() => {
                alert("âœ… ëŒ“ê¸€ ì‚­ì œ ì™„ë£Œ");
                loadComments(bno);
            });
    }

    function openEditModal(cno, comment, bno) {
        document.getElementById("editCno").value = cno;
        document.getElementById("editBno").value = bno;
        document.getElementById("editCommentContent").value = comment;
        document.getElementById("editModal").style.display = "block";
    }

    function closeEditModal() {
        document.getElementById("editModal").style.display = "none";
    }

    function submitEditComment(event) {
        event.preventDefault();
        const cno = document.getElementById("editCno").value;
        const bno = document.getElementById("editBno").value;
        const content = document.getElementById("editCommentContent").value;

        fetch(`/api/admin/posts/comments/${cno}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ comment: content })
        }).then(() => {
            alert("âœï¸ ëŒ“ê¸€ ìˆ˜ì • ì™„ë£Œ");
            closeEditModal();
            loadComments(bno);
        });
    }

    function openPostEditModal(bno, title, content) {
        document.getElementById("editPostBno").value = bno;
        document.getElementById("editPostTitle").value = title;
        document.getElementById("editPostContent").value = content;
        document.getElementById("postEditModal").style.display = "block";
    }

    function closePostEditModal() {
        document.getElementById("postEditModal").style.display = "none";
    }

    function submitPostEdit(event) {
        event.preventDefault();
        const bno = document.getElementById("editPostBno").value;
        const title = document.getElementById("editPostTitle").value;
        const content = document.getElementById("editPostContent").value;

        fetch(`/api/admin/posts/${bno}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ title, content })
        }).then(response => {
            if (response.ok) {
                alert("âœ… ê²Œì‹œê¸€ ìˆ˜ì • ì™„ë£Œ");
                closePostEditModal();
                location.reload();
            } else {
                alert("âŒ ê²Œì‹œê¸€ ìˆ˜ì • ì‹¤íŒ¨");
            }
        });
    }
</script>
</body>
</html>
